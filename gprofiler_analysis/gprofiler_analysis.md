# gProfiler Wrapper Scripts

The objective of the gProfiler wrapper scripts given an input file are two fold:

1. Parse Excel input (or csv for comma-separated values or txt for tab-separated values) file to generate individual gene list files by group for input into gProfiler, and
2. Automate running of each of the group gene list files in gProfiler's [g:GOSt](https://biit.cs.ut.ee/gprofiler/gost) which preforms a functional enrichment analysis.

The input files are produced by this study's upstream analysis workflow using [Scanpy workflow](https://scanpy.readthedocs.io/en/stable/) with the function [scanpy.get.rank_genes_groups_df()](https://scanpy.readthedocs.io/en/stable/generated/scanpy.get.rank_genes_groups_df.html) to generate a python data frame which is then exported as a file.

Parsing of the file is done using the python script *gprofiler_analysis.py* detailed below. From within *gprofiler_analysis.py*, *gprofiler_analysis.R* R script is called to automate the gProfiler's [g:GOSt](https://biit.cs.ut.ee/gprofiler/gost) step.

The results are a set of html files with graphic version of GO terms along with a matching comma-separated values files (csv). A summary html is also provided with summary information and links to the individual html files.

## Create Conda gProfiler Environment

To run the scripts, it is recommended that you create a Conda environment to provide the needed dependencies for the two scripts *gprofiler_analysis.py* and *gprofiler_analysis.R*. Here is how the environment was built:

```BASH
conda create -n gprofiler \
	anaconda::jinja2 \
	anaconda::xlrd \
	bioconda::gprofiler-official \
	conda-forge::r-gprofiler2 \
	conda-forge::r-plotly \
	conda-forge::r-readr \
	openpyxl \
	r-base

conda activate gprofiler
```

The included *exniroment.yml* file details the full resulting set of python modules.

## Test Use
After creating an appropriate Conda environment as directed above, it is recommended that you create a directory named *gprofiler_analsis* with the file contents:

- *gprofiler_analysis.md* - this file describes the use of *gprofiler_analysis.py* python script.
- *gprofiler_analysis.py* - main script that generates gene lists and calls *gprofiler_analysis.R*.
- *gprofiler_analysis.R* - R script that runs the gProfiler.

Examples below assumes that you have the directory structure specified above.

```BASH
# Test as follows
conda activate gprofiler
cd gprofiler_analsis
python gprofiler_analysis.py --help

```

## Parameters Explained for *gprofiler_analysis.py*
Required Parameters:

- \-\-excel_file Path to Excel file created by [scanpy.get.rank_genes_groups_df function](https://scanpy.readthedocs.io/en/stable/generated/scanpy.get.rank_genes_groups_df.html)
- \-\-lfc_cutoff - log fold cutoff, genes will be written to the gene lists in directory *GeneLists*


Optional Parameters:

- \-\-adj_pval_filter - Default adjusted p-value is 0.05, but can be set with this parameter
- \-\-run_gprofiler - will run the included R script *gprofiler_analysis.R* (see section below).
- \-\-use_bkg_known - sets Statistical Domain Scope background ([link](https://biit.cs.ut.ee/gprofiler/page/docs#statistical_domain_scope)). Using parameter will run independently against both:
	1. ***known*** gene set with results found in directory *results_know_bkg* and,
	2. ***custom*** gene set (default) all the genes used in the experiment with results found in directory *results_custom_bkg*
- \-\-out - specify the location of results directory. You must create a directory. If not specified, all the files will be written to the current working directory.

It is recommended that you create a results directory and use the ```--out``` parameter, place the Excel file into that directory and run.

## Example Run
In the example below, we specify the location of the *scripts* and the *output* directories. It is recommended that you create an output directory and place the input Excel file. A hypothetical example is presented below for a bash run on the terminal.

```BASH
## Excel file generated by scanpy.get.rank_genes_groups_df():
## https://scanpy.readthedocs.io/en/stable/generated/scanpy.get.rank_genes_groups_df.html
SCRIPT_DIR="gprofiler_analysis" # Directory location of gprofiler_analysis.py and gprofiler_analysis.R
RUN_DIR="gprofiler_analysis/run" #

# Example run against custom set only.
clear;python $SCRIPT_DIR/gprofiler_analysis.py \
--excel_file "$RUN_DIR/your_excel_file.xlsx" \
--out $RUN_DIR \
--lfc_cutoff 0.5 \
--run_gprofiler

# Or, example independant runs against custom set and known set.

clear;python $SCRIPT_DIR/gprofiler_analysis.py \
--excel_file "$RUN_DIR/my_excel_file.xlsx" \
--out $RUN_DIR \
--lfc_cutoff 0.5 \
--run_gprofiler \
--use_bkg_known
```

## Resulting Directories and Files Explained

All resulting files and directories will be written to the location specified by ```--out``` parameters or if not specified to the current working directory.

Resulting output:

- *gene_counts_summary_table.txt* - a summary of the gene lists in a tab separated file.
	- *Group Id* - Group ID number ranging [0-N]
	- *Filename* - Name of the group
	- *Filtered Genes* - The Number of genes passing filter as specified by ```--adj_pval_filter```
	- *Depleted Genes* - The Number of genes passing log fold-change i.e LFC < -1 with setting ```--lfc_cutoff 1```
	- *Enriched Genes* - The Number of genes passing log fold-change i.e LFC > 1 with setting ```--lfc_cutoff 1```
	- *Min Unfiltered padj* - The minimum value of p adjusted value in group.
	- *Max Unfiltered padj* - The maximum value of p adjusted value in group.
	- *Gene List File* - The resulting gene list name.
- *gProfiler_summary_results.html* - a summary of the run.
	- Section *Parameters Selected*  summarize the parameters selected. Notable, the *Filtered Unique Gene IDs (Custom Background Set)* value is the number of genes used for the [Statistical domain scope](https://biit.cs.ut.ee/gprofiler/page/docs#statistical_domain_scope) custom set. The gene set selected are the genes that pass the adjusted p-value cutoff.
	- *Gene Lists Summary* table section (same as *gene_counts_summary_table.txt*)
	- *Live Links to gProfiler* section. A list of hyperlinks that work in conjunction with [g:GOSt](https://biit.cs.ut.ee/gprofiler/gost) web app. The gene list, custom background and settings propagate to the website allowing for a live and interactive site.
	- *Static Links to gProfiler* - a set of relative links to individual html files located in the *results_custom_bkg* directory.
- *GeneLists* - Gene lists can be imported into gProfiler website for more detailed information.
	- *Group_N_GeneListCombo.txt* - A set of gene lists wher N is the group number from 0 to N.
	- *Group_All_GeneList.csv* - A file required for *gprofiler_analysis.R*
	- *bkg_all_GeneList.txt* - All genes found in the experiment. This is the set used for custom background.
	- *bkg_filtered_GeneList.txt* - All genes passing filter as set by ```--adj_pval_filter```.
- *results_custom_bkg* - Results files generated by *gprofiler_analysis.R* against custom background.
	- **.csv* - Result from *gprofiler_analysis.R* for each of the groups where results are available.
	- **.html* - Visualization of the GO terms for each of the groups where results are available. It is easiest to access the hmtl files via links provided in *gProfiler_summary_results.html*
	- Directories are support files for each of the html.
- *results_know_bkg* - Results files generated by *gprofiler_analysis.R* against known background if ```--use_bkg_known``` parameter was used. Same description of files as with *results_custom_bkg* directory.
- **.cvs* - A set of files that are exported from Excel spreadsheet for use in generating gene lists.
- *custom_urls.txt* - List of gProfiler urls.

## *gprofiler_analysis.R* R Script

The R script *gprofiler_analysis.R* has the role of running [g:GOSt](https://biit.cs.ut.ee/gprofiler/gost). *gprofiler_analysis.R* can be run independently, but it is not recommended, because it requires the file *Group_All_GeneList.csv* which is created by *gprofiler_analysis.py*.

### *gprofiler_analysis.R* Parameters

- \-\-output - results directory which needs to be the same location as *gprofiler_analysis.py* parameter ```--out``. The script will look for file in relative path *GeneLists/Group_All_GeneList.csv*.
- \-\-use_bkg_known - will run against ***known*** gene set with results found in directory *results_know_bkg*. For details see [Statistical Domain Scope background](https://biit.cs.ut.ee/gprofiler/page/docs#statistical_domain_scope).
